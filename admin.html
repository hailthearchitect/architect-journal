<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decoding Death - Admin Dashboard</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #111;
            color: #ddd;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        h1, h2, h3 {
            color: #a70000;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .card {
            background-color: #222;
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-card {
            background-color: #2a2a2a;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #a70000;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th {
            background-color: #2a2a2a;
        }
        button, input, select {
            background-color: #333;
            color: #ddd;
            border: 1px solid #555;
            padding: 8px 12px;
            margin: 5px;
            font-family: 'Courier New', monospace;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background-color: #444;
        }
        .action-button {
            background-color: #a70000;
            color: white;
            border: none;
        }
        .action-button:hover {
            background-color: #800000;
        }
        .player-search {
            display: flex;
            margin-bottom: 20px;
        }
        .player-search input {
            flex: 1;
            margin-right: 10px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #333;
            cursor: pointer;
            border: none;
            border-radius: 0;
        }
        .tab-button.active {
            background-color: #a70000;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 15px;
            background-color: #222;
            border: 1px solid #333;
        }
        .tab-content.active {
            display: block;
        }
        .hidden {
            display: none;
        }
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #a70000;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Decoding Death - Admin Dashboard</h1>
            <div>
                <span id="api-status">API: Unknown</span>
                <button id="refresh-button">Refresh Data</button>
            </div>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="dashboard">Dashboard</button>
                <button class="tab-button" data-tab="player-management">Player Management</button>
                <button class="tab-button" data-tab="waitlist">Waitlist</button>
                <button class="tab-button" data-tab="settings">Settings</button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>Overview</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-players">-</div>
                        <div>Total Players</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-players">-</div>
                        <div>Active Players</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="waitlist-players">-</div>
                        <div>On Waitlist</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completed-players">-</div>
                        <div>Completed Game</div>
                    </div>
                </div>
                
                <h3>Player Progress</h3>
                <div class="card">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="stage1-players">-</div>
                            <div>Stage 1</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stage2-players">-</div>
                            <div>Stage 2</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stage3-players">-</div>
                            <div>Stage 3</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stage4-players">-</div>
                            <div>Stage 4</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="stage5-players">-</div>
                            <div>Stage 5</div>
                        </div>
                    </div>
                </div>
                
                <h3>Recent Activity</h3>
                <div class="card">
                    <table id="recent-activity-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Player</th>
                                <th>Type</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity-body">
                            <tr>
                                <td colspan="5" class="loading-row">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Player Management Tab -->
            <div id="player-management" class="tab-content">
                <h2>Player Management</h2>
                
                <div class="player-search">
                    <input type="text" id="player-search-input" placeholder="Search by email">
                    <button id="player-search-button" class="action-button">Search</button>
                </div>
                
                <div id="player-details" class="card hidden">
                    <h3>Player Details</h3>
                    <div id="player-info">
                        <p><strong>Email:</strong> <span id="player-email"></span></p>
                        <p><strong>Status:</strong> <span id="player-status"></span></p>
                        <p><strong>Current Stage:</strong> <span id="player-stage"></span></p>
                        <p><strong>Joined:</strong> <span id="player-joined"></span></p>
                        <p><strong>Last Interaction:</strong> <span id="player-last-interaction"></span></p>
                    </div>
                    
                    <div class="player-actions">
                        <button id="send-hint-button" class="action-button">Send Hint Email</button>
                        <button id="advance-stage-button" class="action-button">Advance to Next Stage</button>
                    </div>
                    
                    <h3>Player Activity</h3>
                    <table id="player-activity-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="player-activity-body">
                            <!-- Activity rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Waitlist Tab -->
            <div id="waitlist" class="tab-content">
                <h2>Waitlist Management</h2>
                
                <div class="card">
                    <h3>Process Waitlist</h3>
                    <p>Activate players from the waitlist, prioritizing those with the most referrals.</p>
                    
                    <div>
                        <label for="batch-size">Number of players to activate:</label>
                        <input type="number" id="batch-size" min="1" max="50" value="10">
                        <button id="process-waitlist-button" class="action-button">Process Waitlist</button>
                    </div>
                    
                    <div id="waitlist-result" class="hidden">
                        <h4>Activated Players:</h4>
                        <ul id="activated-players-list">
                            <!-- Activated players will be listed here -->
                        </ul>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Waitlisted Players</h3>
                    <table id="waitlist-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Joined</th>
                                <th>Referrals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="waitlist-body">
                            <tr>
                                <td colspan="4" class="loading-row">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2>Settings</h2>
                
                <div class="card">
                    <h3>API Configuration</h3>
                    <div>
                        <label for="api-key">Admin API Key:</label>
                        <input type="password" id="api-key" placeholder="Enter your admin API key">
                        <button id="save-api-key-button">Save</button>
                    </div>
                    <p><small>This key is stored locally in your browser.</small></p>
                </div>
                
                <div class="card">
                    <h3>Game Configuration</h3>
                    <p>These settings affect how the game operates.</p>
                    
                    <div>
                        <label for="hint-delay">Hint Email Delay (hours):</label>
                        <input type="number" id="hint-delay" min="1" max="72" value="24">
                    </div>
                    
                    <div>
                        <label for="waitlist-auto">Auto-process Waitlist:</label>
                        <select id="waitlist-auto">
                            <option value="disabled">Disabled</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    
                    <button id="save-settings-button" class="action-button">Save Settings</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Base API URL
        const API_BASE_URL = 'https://decoding-death-backend.vercel.app/api/admin/dashboard';
        
        // DOM elements
        const apiStatusEl = document.getElementById('api-status');
        const refreshButton = document.getElementById('refresh-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const playerSearchInput = document.getElementById('player-search-input');
        const playerSearchButton = document.getElementById('player-search-button');
        const playerDetailsEl = document.getElementById('player-details');
        const sendHintButton = document.getElementById('send-hint-button');
        const advanceStageButton = document.getElementById('advance-stage-button');
        const batchSizeInput = document.getElementById('batch-size');
        const processWaitlistButton = document.getElementById('process-waitlist-button');
        const waitlistResultEl = document.getElementById('waitlist-result');
        const activatedPlayersListEl = document.getElementById('activated-players-list');
        const apiKeyInput = document.getElementById('api-key');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const saveSettingsButton = document.getElementById('save-settings-button');
        
        // Current player email (for player management)
        let currentPlayerEmail = '';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load API key from local storage
            const apiKey = localStorage.getItem('adminApiKey');
            if (apiKey) {
                apiKeyInput.value = apiKey;
                apiStatusEl.textContent = 'API: Configured';
                apiStatusEl.style.color = '#4CAF50';
                
                // Load dashboard data
                loadDashboardData();
            } else {
                apiStatusEl.textContent = 'API: Not Configured';
                apiStatusEl.style.color = '#F44336';
            }
            
            // Set up event listeners
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all tabs
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load tab-specific data
                    if (tabId === 'dashboard') {
                        loadDashboardData();
                    } else if (tabId === 'waitlist') {
                        loadWaitlistData();
                    }
                });
            });
            
            // Refresh button
            refreshButton.addEventListener('click', loadDashboardData);
            
            // Player search
            playerSearchButton.addEventListener('click', searchPlayer);
            playerSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchPlayer();
                }
            });
            
            // Player actions
            sendHintButton.addEventListener('click', sendHintEmail);
            advanceStageButton.addEventListener('click', advancePlayerStage);
            
            // Waitlist actions
            processWaitlistButton.addEventListener('click', processWaitlist);
            
            // Settings actions
            saveApiKeyButton.addEventListener('click', saveApiKey);
            saveSettingsButton.addEventListener('click', saveSettings);
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            const apiKey = localStorage.getItem('adminApiKey');
            if (!apiKey) {
                alert('Please configure the API key in Settings first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=stats`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                
                // Update player counts
                document.getElementById('total-players').textContent = 
                    Object.values(data.playerCounts).reduce((a, b) => a + b, 0);
                document.getElementById('active-players').textContent = 
                    data.playerCounts.active || 0;
                document.getElementById('waitlist-players').textContent = 
                    data.playerCounts.waitlist || 0;
                document.getElementById('completed-players').textContent = 
                    data.playerCounts.completed || 0;
                
                // Update stage counts
                document.getElementById('stage1-players').textContent = 
                    data.stageCounts['1'] || 0;
                document.getElementById('stage2-players').textContent = 
                    data.stageCounts['2'] || 0;
                document.getElementById('stage3-players').textContent = 
                    data.stageCounts['3'] || 0;
                document.getElementById('stage4-players').textContent = 
                    data.stageCounts['4'] || 0;
                document.getElementById('stage5-players').textContent = 
                    data.stageCounts['5'] || 0;
                
                // Update recent activity
                const activityBody = document.getElementById('recent-activity-body');
                activityBody.innerHTML = '';
                
                if (data.recentActivity && data.recentActivity.length > 0) {
                    data.recentActivity.forEach(activity => {
                        const row = document.createElement('tr');
                        
                        // Format timestamp
                        const date = new Date(activity.received_at);
                        const timeString = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                        
                        row.innerHTML = `
                            <td>${timeString}</td>
                            <td>${activity.player_id.substring(0, 8)}...</td>
                            <td>${activity.interaction_type}</td>
                            <td>${activity.action}</td>
                            <td>${formatDetails(activity.details)}</td>
                        `;
                        
                        activityBody.appendChild(row);
                    });
                } else {
                    activityBody.innerHTML = '<tr><td colspan="5">No recent activity</td></tr>';
                }
                
                apiStatusEl.textContent = 'API: Connected';
                apiStatusEl.style.color = '#4CAF50';
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                apiStatusEl.textContent = 'API: Error';
                apiStatusEl.style.color = '#F44336';
                
                // Show error in recent activity table
                document.getElementById('recent-activity-body').innerHTML = 
                    '<tr><td colspan="5">Error loading data. Check API configuration.</td></tr>';
            }
        }
        
        // Load waitlist data
        async function loadWaitlistData() {
            // This function would load the waitlist data
            // For now, we'll just show a placeholder
            document.getElementById('waitlist-body').innerHTML = 
                '<tr><td colspan="4">API endpoint not yet implemented</td></tr>';
        }
        
        // Search for a player
        async function searchPlayer() {
            const email = playerSearchInput.value.trim();
            if (!email) {
                alert('Please enter a player email.');
                return;
            }
            
            const apiKey = localStorage.getItem('adminApiKey');
            if (!apiKey) {
                alert('Please configure the API key in Settings first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=player&email=${encodeURIComponent(email)}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Player not found');
                }
                
                const data = await response.json();
                
                // Store current player email
                currentPlayerEmail = email;
                
                // Update player details
                document.getElementById('player-email').textContent = data.player.email;
                document.getElementById('player-status').textContent = data.player.status;
                document.getElementById('player-stage').textContent = data.player.current_stage;
                document.getElementById('player-joined').textContent = new Date(data.player.joined_at).toLocaleString();
                document.getElementById('player-last-interaction').textContent = 
                    data.player.last_interaction ? new Date(data.player.last_interaction).toLocaleString() : 'Never';
                
                // Update player activity table
                const activityBody = document.getElementById('player-activity-body');
                activityBody.innerHTML = '';
                
                if (data.interactions && data.interactions.length > 0) {
                    data.interactions.forEach(activity => {
                        const row = document.createElement('tr');
                        
                        // Format timestamp
                        const date = new Date(activity.received_at);
                        const timeString = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                        
                        row.innerHTML = `
                            <td>${timeString}</td>
                            <td>${activity.interaction_type}</td>
                            <td>${activity.action}</td>
                            <td>${formatDetails(activity.details)}</td>
                        `;
                        
                        activityBody.appendChild(row);
                    });
                } else {
                    activityBody.innerHTML = '<tr><td colspan="4">No activity recorded</td></tr>';
                }
                
                // Show player details
                playerDetailsEl.classList.remove('hidden');
            } catch (error) {
                console.error('Error searching player:', error);
                alert('Player not found or API error.');
                playerDetailsEl.classList.add('hidden');
            }
        }
        
        // Send hint email to current player
        async function sendHintEmail() {
            if (!currentPlayerEmail) {
                alert('No player selected.');
                return;
            }
            
            if (!confirm(`Send hint email to ${currentPlayerEmail}?`)) {
                return;
            }
            
            const apiKey = localStorage.getItem('adminApiKey');
            if (!apiKey) {
                alert('Please configure the API key in Settings first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=send-hint&email=${encodeURIComponent(currentPlayerEmail)}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send hint email');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Hint email sent successfully.');
                    // Refresh player data
                    searchPlayer();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error sending hint email:', error);
                alert('Failed to send hint email. Check console for details.');
            }
        }
        
        // Advance player to next stage
        async function advancePlayerStage() {
            if (!currentPlayerEmail) {
                alert('No player selected.');
                return;
            }
            
            if (!confirm(`Advance ${currentPlayerEmail} to the next stage?`)) {
                return;
            }
            
            const apiKey = localStorage.getItem('adminApiKey');
            if (!apiKey) {
                alert('Please configure the API key in Settings first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}?action=advance&email=${encodeURIComponent(currentPlayerEmail)}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to advance player');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message || 'Player advanced successfully.');
                    // Refresh player data
                    searchPlayer();
                } else {
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error advancing player:', error);
                alert('Failed to advance player. Check console for details.');
            }
        }
        
        // Process waitlist
        async function processWaitlist() {
            const batchSize = parseInt(batchSizeInput.value) || 10;
            
            if (!confirm(`Activate ${batchSize} players from the waitlist?`)) {
                return;
            }
            
            const apiKey = localStorage.getItem('adminApiKey');
            if (!apiKey) {
                alert('Please configure the API key in Settings first.');
                return;
            }
            
            try {
                processWaitlistButton.disabled = true;
                processWaitlistButton.innerHTML = '<span class="loading"></span> Processing...';
                
                const response = await fetch(`${API_BASE_URL}?action=process-waitlist&count=${batchSize}`, {
                    method: 'GET',
                    headers: {
                        'x-admin-key': apiKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to process waitlist');
                }
                
                const data = await response.json();
                
                // Reset button
                processWaitlistButton.disabled = false;
                processWaitlistButton.textContent = 'Process Waitlist';
                
                if (data.success) {
                    // Show results
                    waitlistResultEl.classList.remove('hidden');
                    
                    if (data.activated > 0) {
                        activatedPlayersListEl.innerHTML = '';
                        data.players.forEach(email => {
                            const li = document.createElement('li');
                            li.textContent = email;
                            activatedPlayersListEl.appendChild(li);
                        });
                    } else {
                        activatedPlayersListEl.innerHTML = '<li>No players activated</li>';
                    }
                    
                    // Refresh dashboard data
                    loadDashboardData();
                } else {
                    alert(`Error: ${data.error || data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error processing waitlist:', error);
                alert('Failed to process waitlist. Check console for details.');
                
                // Reset button
                processWaitlistButton.disabled = false;
                processWaitlistButton.textContent = 'Process Waitlist';
            }
        }
        
        // Save API key
        function saveApiKey() {
            const apiKey = apiKeyInput.value.trim();
            
            if (!apiKey) {
                alert('Please enter a valid API key.');
                return;
            }
            
            localStorage.setItem('adminApiKey', apiKey);
            alert('API key saved successfully.');
            
            apiStatusEl.textContent = 'API: Configured';
            apiStatusEl.style.color = '#4CAF50';
            
            // Load dashboard data
            loadDashboardData();
        }
        
        // Save settings
        function saveSettings() {
            const hintDelay = document.getElementById('hint-delay').value;
            const waitlistAuto = document.getElementById('waitlist-auto').value;
            
            // Save settings to local storage
            localStorage.setItem('hintDelay', hintDelay);
            localStorage.setItem('waitlistAuto', waitlistAuto);
            
            alert('Settings saved successfully.');
        }
        
        // Format JSON details for display
        function formatDetails(details) {
            if (!details) return '';
            
            try {
                if (typeof details === 'string') {
                    details = JSON.parse(details);
                }
                
                // Return a simple representation of the details
                return Object.entries(details)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(', ');
            } catch (error) {
                return String(details).substring(0, 50);
            }
        }
    </script>
</body>
</html>
